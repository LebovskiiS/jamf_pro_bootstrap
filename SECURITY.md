# Безопасность Jamf Pro Bootstrap API

> **Подробная информация о безопасности, шифровании и лучших практиках**

---

## Содержание

- [Обзор безопасности](#обзор-безопасности)
- [Шифрование данных](#шифрование-данных)
- [Аутентификация](#аутентификация)
- [Защита API](#защита-api)
- [Безопасность базы данных](#безопасность-базы-данных)
- [Мониторинг безопасности](#мониторинг-безопасности)
- [Уязвимости](#уязвимости)
- [Сообщить о проблеме](#сообщить-о-проблеме)

---

## Обзор безопасности

**Jamf Pro Bootstrap API** реализует многоуровневую систему безопасности для защиты корпоративных данных и обеспечения конфиденциальности информации о сотрудниках.

### Принципы безопасности

- **Шифрование на всех уровнях** - данные шифруются при передаче и хранении
- **Принцип наименьших привилегий** - минимальные права доступа
- **Defense in Depth** - многоуровневая защита
- **Аудит и мониторинг** - полное логирование операций
- **Ротация секретов** - регулярное обновление ключей

---

## Шифрование данных

### Шифрование запросов от CRM

#### Алгоритм шифрования
- **Алгоритм**: Fernet (AES-128 в режиме CBC)
- **Ключ**: 32-байтовый ключ, генерируемый PBKDF2
- **Соль**: Фиксированная соль для совместимости
- **Итерации**: 100,000 для PBKDF2

#### Процесс шифрования

```python
# 1. Генерация ключа через PBKDF2
kdf = PBKDF2HMAC(
    algorithm=hashes.SHA256(),
    length=32,
    salt=b'jamf_bootstrap_salt',
    iterations=100000,
)
key = base64.urlsafe_b64encode(kdf.derive(encryption_key.encode()))

# 2. Шифрование данных
fernet = Fernet(key)
encrypted_data = fernet.encrypt(json_data.encode())
```

#### Структура зашифрованных данных

```
CRM данные → Шифрование ключом CRM → Шифрование ключа ключом Vault → Отправка
```

### Шифрование ключей

#### Двойное шифрование
1. **Ключ CRM** шифруется ключом из Vault
2. **Ключ Vault** хранится в HashiCorp Vault
3. **API** расшифровывает ключ CRM своим ключом из Vault

#### Алгоритм для ключей
- **Алгоритм**: Fernet (AES-128)
- **Ключ Vault**: 32-байтовый ключ из Vault
- **Безопасность**: Ключи никогда не передаются в открытом виде

### Проверка целостности

#### SHA256 Checksum
- **Алгоритм**: SHA256
- **Назначение**: Проверка целостности данных
- **Проверка**: При каждом запросе

```python
# Генерация checksum
checksum = hashlib.sha256(data.encode()).hexdigest()

# Проверка целостности
def verify_checksum(data: str, checksum: str) -> bool:
    return hashlib.sha256(data.encode()).hexdigest() == checksum
```

---

## Аутентификация

### HashiCorp Vault AppRole

#### Механизм аутентификации
- **Метод**: AppRole Authentication
- **TTL токена**: 1 час
- **Максимальный TTL**: 4 часа
- **Ротация**: Автоматическая

#### Настройка AppRole

```bash
# Создание политики
vault policy write jamf-bootstrap-policy -<<EOF
path "secret/jamf-bootstrap-*" {
  capabilities = ["read"]
}
path "secret/jamf-pro-*" {
  capabilities = ["read"]
}
path "secret/database-*" {
  capabilities = ["read"]
}
EOF

# Создание AppRole
vault write auth/approle/role/jamf-bootstrap \
  token_policies="jamf-bootstrap-policy" \
  token_ttl=1h \
  token_max_ttl=4h
```

### Токены API

#### Валидация токенов
- **Проверка**: Каждый запрос проверяется на валидность токена
- **Источник**: Токены хранятся в HashiCorp Vault
- **Ротация**: Токены ротируются автоматически

#### Структура токена
```json
{
  "token": "valid-token-from-vault",
  "expires_at": "2024-01-01T12:00:00Z",
  "permissions": ["read", "write"]
}
```

---

## Защита API

### Rate Limiting

#### Ограничения запросов
- **Лимит**: 100 запросов в минуту на IP
- **Блокировка**: 15 минут при превышении лимита
- **Логирование**: Все попытки превышения лимита

### CORS и заголовки безопасности

#### Настройки CORS
```python
CORS_ORIGINS = [
    "https://your-crm-domain.com",
    "https://your-admin-panel.com"
]

CORS_METHODS = ["GET", "POST"]
CORS_HEADERS = ["Content-Type", "Authorization"]
```

#### Заголовки безопасности
```python
SECURITY_HEADERS = {
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY",
    "X-XSS-Protection": "1; mode=block",
    "Strict-Transport-Security": "max-age=31536000; includeSubDomains",
    "Content-Security-Policy": "default-src 'self'"
}
```

### Валидация входных данных

#### Проверка данных
- **JSON Schema**: Валидация структуры запросов
- **Типы данных**: Строгая типизация
- **Санитизация**: Очистка от вредоносного кода
- **Размер данных**: Ограничение размера запросов

---

## Безопасность базы данных

### PostgreSQL Security

#### SSL соединение
- **SSL Mode**: require
- **Сертификаты**: Google Cloud SQL сертификаты
- **Верификация**: Проверка сертификатов

#### Настройки подключения
```python
DATABASE_CONFIG = {
    "host": "10.79.160.3",  # Внутренний IP
    "port": 5432,
    "database": "jamf_bootstrap_prod",
    "user": "jamf_user",
    "password": "from-vault",
    "sslmode": "require",
    "sslcert": "/path/to/client-cert.pem",
    "sslkey": "/path/to/client-key.pem",
    "sslrootcert": "/path/to/server-ca.pem"
}
```

### Шифрование в базе данных

#### Зашифрованные поля
- **payload**: Зашифрованные данные сотрудника (base64)
- **encrypted_key**: Зашифрованный ключ (base64)
- **checksum**: SHA256 хеш для проверки целостности

#### Нешифрованные поля (для поиска)
- **request_id**: UUID запроса
- **crm_id**: ID CRM системы
- **status**: Статус обработки
- **created_at**: Временная метка

---

## Мониторинг безопасности

### Логирование безопасности

#### События для логирования
- Успешные аутентификации
- Неудачные попытки аутентификации
- Операции шифрования/дешифрования
- Создание/обновление/удаление записей
- Подозрительная активность

#### Формат логов
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "level": "INFO",
  "event": "authentication_success",
  "ip_address": "192.168.1.100",
  "user_agent": "CRM-System/1.0",
  "request_id": "abc-123-def-456",
  "details": {
    "crm_id": "crm-123",
    "department": "IT"
  }
}
```

### Аудит безопасности

#### Регулярные проверки
- **Ежедневно**: Проверка логов на подозрительную активность
- **Еженедельно**: Аудит прав доступа
- **Ежемесячно**: Ротация ключей и токенов
- **Ежеквартально**: Пентестинг системы

#### Метрики безопасности
- Количество неудачных аутентификаций
- Время отклика API
- Количество ошибок шифрования
- Статус соединений с Vault

---

## Уязвимости

### Известные уязвимости

#### Нет известных критических уязвимостей

Система использует:
- Последние версии библиотек
- Проверенные алгоритмы шифрования
- Безопасные протоколы передачи данных
- Регулярные обновления безопасности

### Рекомендации по безопасности

#### Для администраторов
1. **Регулярно обновляйте** зависимости
2. **Мониторьте логи** на подозрительную активность
3. **Ротируйте ключи** каждые 90 дней
4. **Проводите пентестинг** каждые 6 месяцев
5. **Обновляйте сертификаты** до истечения срока

#### Для разработчиков
1. **Не храните секреты** в коде
2. **Используйте HTTPS** для всех соединений
3. **Валидируйте входные данные**
4. **Логируйте все операции**
5. **Тестируйте безопасность** перед деплоем

---

## Сообщить о проблеме

### Сообщить об уязвимости

Если вы обнаружили уязвимость в системе безопасности:

#### Контактная информация
- **Email**: sergei@pharmacyhub.com
- **Тема**: [SECURITY] Уязвимость в Jamf Pro Bootstrap API
- **Ответ**: В течение 24 часов

#### Информация для включения
1. **Описание уязвимости** - подробное описание проблемы
2. **Шаги для воспроизведения** - пошаговая инструкция
3. **Возможное влияние** - оценка риска
4. **Предложения по исправлению** - ваши рекомендации
5. **Контактная информация** - для обратной связи

### Политика ответственного раскрытия

#### Наши обязательства
- Рассматриваем все сообщения об уязвимостях
- Отвечаем в течение 24 часов
- Признаем вашу помощь в исправлении
- Публикуем информацию об исправлениях
- Не преследуем за добросовестное тестирование

#### Ваши обязательства
- Не используйте уязвимости для вредоносных целей
- Не нарушайте конфиденциальность данных
- Сообщайте об уязвимостях ответственно
- Дайте время на исправление
- Сотрудничайте в процессе исправления

---

## Чек-лист безопасности

### Ежедневные проверки
- [ ] Проверка логов на подозрительную активность
- [ ] Мониторинг количества запросов
- [ ] Проверка статуса соединений с Vault
- [ ] Валидация SSL сертификатов

### Еженедельные проверки
- [ ] Аудит прав доступа пользователей
- [ ] Проверка ротации токенов
- [ ] Анализ метрик безопасности
- [ ] Обновление зависимостей

### Ежемесячные проверки
- [ ] Ротация ключей шифрования
- [ ] Обновление сертификатов
- [ ] Проверка политик безопасности
- [ ] Аудит конфигурации

### Ежеквартальные проверки
- [ ] Пентестинг системы
- [ ] Обзор архитектуры безопасности
- [ ] Обновление планов реагирования
- [ ] Обучение команды

---

<div align="center">

**Безопасность - наш приоритет**

*Последнее обновление: Январь 2024*

</div>
